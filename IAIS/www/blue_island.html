<!DOCTYPE html>
<html>
  <head>
    <!--meta http-equiv="refresh" content="8" -->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="iais.css">
    <script src="mqttws31.js" type="text/javascript"></script>    
    <script src="konva.min.js"></script>    
    <script src="txn.js"></script>
    <title>Blue Island</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
      }
      
      #stage-parent {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="stage-parent">
      <div id="container">
        <div class="konvajs-content" role="presentation" style="position: relative; width: 800px; height: 600px;">
        </div>
      </div>
    </div>
    <script type="text/javascript">
      SUBSCRIBED1 = 'IAIS/turnout/0015';

      var subscriptions = [ "/14", "/15", "/16" ];

      MYNAME = 'Blue Island';

      DRAGGING = true;
      
      // diag under mainline, draw first
      
      // mainline
      // arr.push( { key:  1, imageIdx: 5, locked: true,  state: true, x:  20, y: 107, width:  85, rotation:    0, ssn: "TxN" } );
      arr.push( { key: 20, imageIdx: 5, locked: true,  state: true, x: 260, y:  100, width: 70, rotation:    0, ssn: "TxN" } );
      // arr.push( { key:  5, imageIdx: 5, locked: true,  state: true, x: 108, y:  94, width: 123, rotation:  -45, ssn: "TxN" } );
           
      arr.push( { key: 22, imageIdx: 2, locked: true,  state: true, x: 260, y:  100, width:  70, rotation:    0, ssn: "TxN" } );
      arr.push( { key:  1, imageIdx: 1, locked:false,  state: true, x:  369, y: 151, width:  40, rotation:  180, ssn: "IAIS\/turnout\/0015\/14" } )
      // arr.push( { key:  9, imageIdx: 0, locked:false,  state: true, x:  95, y:  95, width:  40, rotation:    0, ssn: "IAIS\/turnout\/0015\/99", inv:true } )
      arr.push( { key: 26, imageIdx: 2, locked: true,  state: true, x: 416, y:  60, width: 237, rotation:    0, ssn: "TxN" } );
      arr.push( { key: 28, imageIdx:15, locked:false,  state: true, x: 624, y:  68, width:  24, rotation:    0, ssn: ";1;-2" } ); // we start with a ; to filter, and then split and don't use element 0
      arr.push( { key: 30, imageIdx: 2, locked: true,  state: true, x: 409, y: 100, width: 244, rotation:    0, ssn: "TxN" } );
      arr.push( { key: 32, imageIdx:15, locked:false,  state: true, x: 600, y: 108, width:  24, rotation:    0, ssn: ";1;2" } );

      arr.push( { key: 34, imageIdx: 2, locked: true,  state: true, x: 403, y: 131, width: 250, rotation:    0, ssn: "TxN" } );
      arr.push( { key: 36, imageIdx:15, locked:false,  state: true, x: 624, y: 139, width:  24, rotation:    0, ssn: ";-1;-3" } );
      arr.push( { key:  2, imageIdx: 0, locked:false,  state: true, x: 369, y:  88, width:  40, rotation:    0, ssn: "IAIS\/turnout\/0015\/15" } );

      // siding
      arr.push( { key:  3, imageIdx: 0, locked:false,  state: true, x: 384, y: 122, width:  40, rotation:   45, ssn: "IAIS\/turnout\/0015\/16" } );
      arr.push( { key: 42, imageIdx: 2, locked: true,  state: true, x: 402, y: 166, width:250, rotation:    0, ssn: "TxN" } );
      arr.push( { key: 44, imageIdx:15, locked:false,  state: true, x: 600, y: 174, width: 24, rotation:    0, ssn: ";-1;3" } );
      
      // diags
      arr.push( { key: 46, imageIdx: 2, locked: true,  state: true, x: 403, y: 158, width:  21, rotation:   45, ssn: "TxN" } );
      arr.push( { key: 48, imageIdx: 2, locked: true,  state: true, x: 389, y:  80, width:  21, rotation:  -45, ssn: "TxN" } );

      // X-overs last to be on top
      
      texts = [];
      texts.push( new Konva.Text( { x: 260, y: 100, fontFamily: 'Arial', fontSize: 12, text: '< Bureau (BU)', fill: 'black' } ) );
      texts.push( new Konva.Text( { x: 260, y:  85, fontFamily: 'Arial', fontSize: 12, text: '< Ottawa', fill: 'black' } ) );
      texts.push( new Konva.Text( { x: 260, y: 127, fontFamily: 'Arial', fontSize: 10, text: 'West', fill: 'black' } ) );

      texts.push( new Konva.Text( { x: 500, y:  60, fontFamily: 'Arial', fontSize: 12, text: 'Staging Track #4', fill: 'black' } ) );
      texts.push( new Konva.Text( { x: 500, y: 100, fontFamily: 'Arial', fontSize: 12, text: 'Staging Track #3', fill: 'black' } ) );

      texts.push( new Konva.Text( { x: 500, y: 132, fontFamily: 'Arial', fontSize: 12, text: 'Staging Track #2', fill: 'black' } ) );
      texts.push( new Konva.Text( { x: 500, y: 166, fontFamily: 'Arial', fontSize: 12, text: 'Staging Track #1', fill: 'black' } ) );
      texts.push( new Konva.Text( { x: 364, y: 200, fontFamily: 'Arial', fontSize: 16, text: 'Blue Island', fill: 'black', fill: '#007F7F' } ) );												      

      // textDebug from txn.js
      texts.push( textDebug );

      for( i = 0; i < texts.length; i++ ) {
        textLayer.add( texts[i] );
      }

      myWidth = 780;
      myHeight = 220;
                      
      var stage = new Konva.Stage( {
        container: 'container',
        width: myWidth,
        height: myHeight
      } );
     
      stage.on( 'click', function( evt ) {
        doIt( evt );
      } );  // on
     
      stage.on( 'tap', function( evt ) {
        doIt( evt );
      } );  // on
     
      loadImages( arr, imageLayer );
     
      stage.add( textLayer );
      stage.add( imageLayer );

      setupClient( MYNAME );
     
      // connect the client
      client.connect( options );

      fitStageIntoParentContainer();
      // adapt the stage on any window resize
      window.addEventListener( 'resize', fitStageIntoParentContainer );
    

      function myFunction( myIndex ) {
        if( myIndex == "" ) return;
        index = parseInt( myIndex, 10 );
        if( index > 0 ) {
          //console.log( "+" + subscriptions[Math.abs( index )-1] );
          publish( SUBSCRIBED1+subscriptions[Math.abs( index )-1], "CLOSED" );
        } else {
          //console.log( "-" + subscriptions[Math.abs( index )-1] );
          publish( SUBSCRIBED1+subscriptions[Math.abs( index )-1], "THROWN" );
        }

      }

      function butClick( e ) {
        splitParts = e.split(";");   // the first element, "" will not be used
        numElements = splitParts.length;
        //console.log( "======>" + e + " " + numElements );
        
         splitParts.forEach( myFunction );


        //publish( SUBSCRIBED1+subscriptions[i], "THROWN" );
        // buttonId = e.target.id[3];
        // console.log( buttonId );
        // setClearServos( onStates[buttonId], offStates[buttonId] );
        // state |= onStates[buttonId];
        // state &= ~offStates[buttonId];
        // checkRoute();
      } // butClick( e )


      //
      // Google Drive has the draggable code that was removed here
      //
      function updateText( e ) {
        if ( e ) {
          var lines = [
            'arr.push( { key: ' + e.target.id,
            'imageIdx: ' + e.target.imageIdx,
            'locked: ' + e.target.locked,
            'inv: ' + e.target.inv,		     
            'state: ' + e.target.state,
            'x: ' + e.target.x(),
            'y: ' + e.target.y(),
     
            'width: ' + e.target.width(),
            'height: ' + e.target.height(),
            'rotation: ' + e.target.rotation(),
            'ssn: "' + e.target.ssn + '" } );'
           ];
           var newText = lines.join('; '); 

          document.getElementById('_info').innerHTML = "info ->" + newText;
          textLayer.batchDraw();
        }
      }   
    </script>
    <br>        
    <table>
      <tr>
        <td><a href="bureau.html">BU</a></td>
        <td>#==#</td>
        <td><a href="henry.html">Henry</a></td>
        <td>  ||  </td>
        <td><a href="blue_island_button.html">Blue Island Buttons</a></td>
      </tr>
    </table>
    <p id="_route"></p>
    <p id="_info"></p>
    <div class="footer">
      <a href="/"><div id="_logLine">...connecting ...</div></a>
      <div id="_logSent"></div>
    </div>
  </body>
</html>
